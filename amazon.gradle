import org.lenskit.gradle.*

task sampleAmazonUsers(type: Exec, group: 'prepare') {
    executable 'Rscript'

    inputs.file "preproc/sample-users.R"
    outputs.file "$buildDir/az-ratings.csv"
    outputs.file "$buildDir/sample-users-amazon.csv"
    outputs.file "$buildDir/sample-ratings-amazon.csv"
    outputs.file "$buildDir/sample-user-stubs-amazon.csv"

    args 'preproc/sample-users.R'
    args '--rating-table', 'az_export_ratings'
    args '--rating-file', "$buildDir/az-ratings.csv"
    args '--user-output', "$buildDir/sample-users-amazon.csv"
    args '--rating-output', "$buildDir/sample-ratings-amazon.csv"
    args '--stub-output', "$buildDir/sample-user-stubs-amazon.csv"
}

/* Run the Lenskit Explicit evaluation on Amazon Dataset*/
task evaluateAZExplicit(type: TrainTest, group: 'evaluate') {
    description 'Runs the Lenskit evaluation on amazon dataset.'
//    logFile "$buildDir/amazonExplicit.log"
//    logFileLevel 'DEBUG'

    outputFile "$buildDir/eval-results-explicit-amazon.csv"

    userOutputFile "$buildDir/eval-users-explicit-amazon.csv"

    // configure our algorithms
    algorithm 'UserUser', 'algorithms/amazon/user-user.groovy'
    algorithm 'ItemItem', 'algorithms/amazon/item-item.groovy'
    algorithm 'Bias', 'algorithms/amazon/pers-mean.groovy'
    algorithm 'FunkSVD', 'algorithms/amazon/funksvd.groovy'
    algorithm 'Popularity', 'algorithms/amazon/popularity.groovy'
    algorithm 'PF', 'algorithms/amazon/pf.groovy'


    dataSet {
        trainSource "data/train-amazon.yaml"
        testSource "data/test-amazon.yaml"
    }

    recommend {
        listSize 100
        candidateItems "allItems"
        excludeItems "user.trainItems"
        outputFile "$buildDir/eval-recommendation-explicit-amazon.csv"
    }
}


/* Run the Lenskit Implicit evaluation on Amazon Dataset*/
task evaluateAZImplicit(type: TrainTest, group: 'evaluate') {
    description 'Runs the Lenskit evaluation on amazon dataset.'
//    logFile "$buildDir/amazonImplicit.log"
//    logFileLevel 'DEBUG'

    outputFile "$buildDir/eval-results-implicit-amazon.csv"

    userOutputFile "$buildDir/eval-users-implicit-amazon.csv"

    // configure our algorithms
    algorithm 'UserUser-Implicit', 'algorithms/amazon/user-user-implicit.groovy'
    algorithm 'ItemItem-Implicit', 'algorithms/amazon/item-item-implicit.groovy'
    algorithm 'FunkSVD-Implicit', 'algorithms/amazon/funksvd-implicit.groovy'
    algorithm 'PF-Implicit', 'algorithms/amazon/pf-implicit.groovy'


    dataSet {
        trainSource "data/train-amazon.yaml"
        testSource "data/test-amazon.yaml"
    }

    recommend {
        listSize 100
        candidateItems "allItems"
        excludeItems "user.trainItems"
        outputFile "$buildDir/eval-recommendation-implicit-amazon.csv"
    }
}
